# Настройка системы отзывов товаров

## Обзор

Система отзывов товаров позволяет покупателям оставлять отзывы с оценками (1-5 звезд) о товарах в магазине. Система включает:

- **Авторизацию через Telegram** - пользователи должны быть авторизованы через Telegram для оставления отзывов
- **Модерацию отзывов** - все отзывы проходят модерацию перед публикацией
- **Лайки и жалобы** - пользователи могут лайкать отзывы и жаловаться на неподходящий контент
- **Админ-панель** - полная система модерации в админке

## Установка

### 1. Применение миграций базы данных

Выполните миграции для создания необходимых таблиц:

```bash
# На хостинге
https://ваш-сайт.ru/apply-product-reviews-migration.php
```

Или локально:

```bash
php apply-product-reviews-migration.php
```

### 2. Проверка созданных таблиц

После применения миграций проверьте создание таблиц:

```bash
# На хостинге
https://ваш-сайт.ru/check-tables.php
```

### 3. Настройка Telegram бота

Убедитесь, что Telegram бот настроен для авторизации:

1. **Bot Token** - должен быть настроен в конфигурации
2. **Login Widget** - должен быть настроен в виджете авторизации
3. **Webhook** - для уведомлений о новых отзывах (опционально)

## Структура базы данных

### Таблица `product_reviews`

- `id` - уникальный ID отзыва
- `product_id` - ID товара
- `telegram_user_id` - ID пользователя Telegram
- `rating` - оценка от 1 до 5
- `text` - текст отзыва
- `status` - статус модерации (pending/approved/rejected)
- `moderator_comment` - комментарий модератора
- `created_at` - дата создания
- `updated_at` - дата обновления

### Таблица `product_review_likes`

- `id` - уникальный ID лайка
- `review_id` - ID отзыва
- `telegram_user_id` - ID пользователя Telegram
- `created_at` - дата создания

### Таблица `product_review_reports`

- `id` - уникальный ID жалобы
- `review_id` - ID отзыва
- `telegram_user_id` - ID пользователя, подавшего жалобу
- `reason` - причина жалобы
- `status` - статус жалобы (pending/reviewed/resolved)
- `moderator_comment` - комментарий модератора
- `created_at` - дата создания
- `updated_at` - дата обновления

## Функциональность

### Для пользователей

1. **Авторизация через Telegram**

   - Пользователи должны быть авторизованы через Telegram
   - Используется официальный Telegram Login Widget

2. **Оставление отзывов**

   - Оценка от 1 до 5 звезд
   - Текст отзыва (10-1000 символов)
   - Один отзыв на товар от пользователя

3. **Взаимодействие с отзывами**
   - Лайки отзывов
   - Жалобы на неподходящий контент

### Для администраторов

1. **Модерация отзывов**

   - Просмотр всех отзывов
   - Фильтрация по статусу
   - Одобрение/отклонение отзывов
   - Добавление комментариев модератора

2. **Управление жалобами**

   - Просмотр жалоб на отзывы
   - Обработка жалоб
   - Комментарии модератора

3. **Статистика**
   - Количество отзывов по статусам
   - Общая статистика

## API Endpoints

### `/api/product-reviews.php`

#### GET параметры:

- `action=list` - получение списка отзывов
- `action=count` - получение количества отзывов
- `product_id` - ID товара
- `page` - номер страницы
- `limit` - количество на странице

#### POST параметры:

- `action=add` - добавление отзыва
- `action=like` - лайк/анлайк отзыва
- `action=report` - жалоба на отзыв

### `/admin/api/moderate-product-review.php`

#### POST параметры:

- `review_id` - ID отзыва
- `action` - действие (approved/rejected)
- `comment` - комментарий модератора

## Интеграция

### На странице товара

Виджет автоматически интегрирован в страницу товара (`product.php`) в разделе "Отзывы".

```php
<?php
$productId = $product['id'];
$showTitle = false;
include $rootPath . '/includes/product-reviews-widget.php';
?>
```

### В админ-панели

Доступ к модерации отзывов:

- **URL**: `/admin/product-reviews.php`
- **Права**: `reviews` permission
- **Меню**: "Отзывы товаров"

## Настройка уведомлений

### Telegram уведомления

Система может отправлять уведомления в Telegram о:

- Новых отзывах на модерацию
- Жалобах на отзывы

Для настройки уведомлений обновите функции:

- `sendTelegramNotification()` в `/api/product-reviews.php`
- `sendTelegramReportNotification()` в `/api/product-reviews.php`

## Безопасность

1. **CSRF защита** - все формы защищены от CSRF атак
2. **Валидация данных** - все входные данные валидируются
3. **Авторизация** - доступ только для авторизованных пользователей
4. **Модерация** - все отзывы проходят модерацию

## Стилизация

Виджет использует CSS переменные для темизации:

- `--brand-primary` - основной цвет
- `--brand-light` - светлый фон
- `--brand-gray` - серый цвет
- `--brand-text` - цвет текста
- `--brand-danger` - цвет ошибок

Поддерживается темная тема через класс `.dark-mode`.

## Тестирование

### Тестовые сценарии

1. **Авторизация**

   - Вход через Telegram
   - Выход из системы

2. **Оставление отзывов**

   - Добавление отзыва с оценкой
   - Валидация полей
   - Ограничение одного отзыва на товар

3. **Модерация**

   - Одобрение отзыва
   - Отклонение отзыва
   - Добавление комментария

4. **Взаимодействие**
   - Лайки отзывов
   - Жалобы на отзывы

### Проверка работоспособности

1. Откройте страницу товара
2. Перейдите на вкладку "Отзывы"
3. Авторизуйтесь через Telegram
4. Оставьте тестовый отзыв
5. Проверьте модерацию в админке

## Поддержка

При возникновении проблем проверьте:

1. **Логи ошибок** - `/logs/` директория
2. **База данных** - убедитесь, что таблицы созданы
3. **Telegram бот** - проверьте настройки бота
4. **Права доступа** - убедитесь, что у пользователя есть права `reviews`

## Обновления

Для обновления системы:

1. Сделайте резервную копию базы данных
2. Обновите файлы
3. Примените новые миграции (если есть)
4. Проверьте работоспособность

## Файлы системы

### Основные файлы:

- `/includes/product-reviews-widget.php` - виджет отзывов
- `/api/product-reviews.php` - API для отзывов
- `/admin/product-reviews.php` - страница модерации
- `/admin/api/moderate-product-review.php` - API модерации
- `/database/product-reviews-migration.sql` - миграции БД

### Вспомогательные файлы:

- `/admin/api/get-product-review-details.php` - детали отзыва
- `/admin/api/get-product-review-reports.php` - жалобы
- `/apply-product-reviews-migration.php` - скрипт миграций
