# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Telegram

## üîç **–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã**

–ò–∑ —Ç–µ—Å—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å:

- ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ —Å–µ—Å—Å–∏–∏** - –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ `$_SESSION['telegram_user']`
- ‚ùå **Telegram WebApp –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ JavaScript** - `window.Telegram.WebApp` –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- ‚ùå **–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–∑—ã–≤–∞** - "–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä"

## üõ†Ô∏è **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**

### 1. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–ª—Å—è –æ—Å—Ç–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π –æ—Ç–∑—ã–≤ –Ω–∞ —Ç–æ—Ç –∂–µ —Ç–æ–≤–∞—Ä
**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

#### –í –≤–∏–¥–∂–µ—Ç–µ (`includes/product-reviews-widget.php`):

```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ—Ç–∑—ã–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function checkExistingReview() {
  const widget = document.querySelector('.product-reviews-widget')
  const productId = widget.dataset.productId
  const addReviewSection = document.getElementById('addReviewSection')

  try {
    const response = await fetch(
      `/api/product-reviews.php?action=check_user_review&product_id=${productId}`
    )
    const result = await response.json()

    if (result.success) {
      if (result.has_review) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª –æ—Ç–∑—ã–≤
        addReviewSection.innerHTML = `
          <div class="user-already-reviewed">
            <div class="already-reviewed-icon">
              <svg>...</svg>
            </div>
            <div class="already-reviewed-text">
              <h4>–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!</h4>
              <p>–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä. –û–Ω –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.</p>
            </div>
          </div>
        `
      } else {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
        addReviewSection.style.display = 'block'
      }
    }
  } catch (error) {
    console.error('Error checking existing review:', error)
    addReviewSection.style.display = 'block'
  }
}
```

#### CSS —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

```css
.user-already-reviewed {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  margin-bottom: 24px;
}

.already-reviewed-icon {
  flex-shrink: 0;
  width: 48px;
  height: 48px;
  background: #28a745;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.already-reviewed-text h4 {
  margin: 0 0 8px 0;
  color: #28a745;
  font-size: 18px;
  font-weight: 600;
}

.already-reviewed-text p {
  margin: 0;
  color: #6c757d;
  font-size: 14px;
  line-height: 1.5;
}
```

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ API –¥–µ–π—Å—Ç–≤–∏–µ**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∑—ã–≤
**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ `check_user_review`

#### –í API (`api/product-reviews.php`):

```php
case 'check_user_review':
  handleCheckUserReview($pdo);
  break;
```

#### –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```php
function handleCheckUserReview($pdo)
{
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  if (!isset($_SESSION['telegram_user']) || empty($_SESSION['telegram_user'])) {
    sendError('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram');
  }

  $productId = $_GET['product_id'] ?? '';
  $telegramUser = $_SESSION['telegram_user'];

  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∑—ã–≤ –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä
    $sql = "
            SELECT id FROM product_reviews
            WHERE product_id = :product_id AND telegram_user_id = :telegram_user_id
        ";
    $stmt = $pdo->prepare($sql);
    $stmt->bindValue(':product_id', $productId, PDO::PARAM_STR);
    $stmt->bindValue(':telegram_user_id', $telegramUser['id'], PDO::PARAM_INT);
    $stmt->execute();

    $hasReview = $stmt->fetch() !== false;

    sendSuccess([
      'has_review' => $hasReview
    ]);
  } catch (PDOException $e) {
    error_log("Database error in handleCheckUserReview: " . $e->getMessage());
    sendError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–∑—ã–≤–∞');
  }
}
```

### 3. **–£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∞, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ —Å–µ—Å—Å–∏—é, –Ω–æ –Ω–µ —á–µ—Ä–µ–∑ Telegram WebApp
**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ã—á–Ω—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏

#### –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```javascript
function checkAuthStatus() {
  const authSection = document.getElementById('telegramAuthSection')
  const addReviewSection = document.getElementById('addReviewSection')
  const reviewFormSection = document.getElementById('reviewFormSection')

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏
  const isAuthenticated =
    authSection.querySelector('.telegram-user-info') !== null

  if (isAuthenticated) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Ç–∑—ã–≤
    checkExistingReview()
  } else {
    addReviewSection.style.display = 'none'
    reviewFormSection.style.display = 'none'
  }
}
```

## üìã **–§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ**

1. **`includes/product-reviews-widget.php`** - –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥–∂–µ—Ç –æ—Ç–∑—ã–≤–æ–≤
2. **`api/product-reviews.php`** - API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–∑—ã–≤–∞–º–∏

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

### 1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é:**

- –û—Ç–∫—Ä–æ–π—Ç–µ `https://–≤–∞—à-—Å–∞–π—Ç.ru/test-telegram-auth.php`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ —Å–µ—Å—Å–∏–∏

### 2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤:**

- –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–û—Ç–∑—ã–≤—ã"
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –æ—Å—Ç–∞–≤–ª—è–ª –æ—Ç–∑—ã–≤, –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!"

### 3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∞–π–∫–∏:**

- –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫
- –í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤

### 4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤—ã–µ –æ—Ç–∑—ã–≤—ã:**

- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª –æ—Ç–∑—ã–≤, –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ "–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤"
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤

## ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–±—ã—á–Ω—ã–º–∏ –±—Ä–∞—É–∑–µ—Ä–∞–º–∏ (–Ω–µ —Ç–æ–ª—å–∫–æ Telegram WebApp)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ç–∑—ã–≤–æ–≤
- ‚úÖ –ö—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –æ—Ç–∑—ã–≤
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –õ–∞–π–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üö® **–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã**

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ —Å–µ—Å—Å–∏—é:

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ `$_SESSION['telegram_user']`
- JavaScript –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ `window.Telegram.WebApp` (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤)
- –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PHP —Å–µ—Å—Å–∏—é –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –æ–¥–∏–Ω –æ—Ç–∑—ã–≤:

- –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ—Ç–∑—ã–≤ –Ω–∞ —Ç–æ–≤–∞—Ä
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ—Å—Ç–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π –æ—Ç–∑—ã–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º –∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤

–°–∏—Å—Ç–µ–º–∞ –æ—Ç–∑—ã–≤–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ
