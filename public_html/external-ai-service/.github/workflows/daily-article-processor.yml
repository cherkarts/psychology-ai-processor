name: Daily Psychology Article Processor

on:
  schedule:
    # Запуск каждый день в 9:00 UTC (12:00 по Москве)
    - cron: '0 9 * * *'

  # Ручной запуск
  workflow_dispatch:
    inputs:
      max_articles:
        description: 'Maximum articles to process'
        required: false
        default: '3'
        type: string

jobs:
  process-articles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r public_html/external-ai-service/requirements.txt

      - name: Create environment file
        run: |
          cd public_html/external-ai-service
          cat > .env << EOF
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          UNSPLASH_ACCESS_KEY=${{ secrets.UNSPLASH_ACCESS_KEY }}
          MAX_ARTICLES_PER_DAY=${{ github.event.inputs.max_articles || '3' }}
          MIN_WORD_COUNT=12000
          MAX_WORD_COUNT=18000
          ANALYSIS_MODEL=gpt-3.5-turbo
          WRITING_MODEL=gpt-3.5-turbo
          USE_GPT4_FOR_COMPLEX=false
          LOG_LEVEL=INFO
          EOF

      - name: Run article processor
        run: |
          cd public_html/external-ai-service
          python new_ai_processor.py

      - name: Upload generated articles
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: psychology-articles-${{ github.run_number }}
          path: |
            public_html/external-ai-service/psychology_articles_*.json
            public_html/external-ai-service/psychology_processor.log
          retention-days: 30

      - name: Commit and push results
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Добавляем сгенерированные файлы
          git add public_html/external-ai-service/psychology_articles_*.json
          git add public_html/external-ai-service/used_links.json

          # Коммитим, если есть изменения
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generated psychology articles - $(date '+%Y-%m-%d %H:%M')"
            git push
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## 📊 Daily Article Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Проверяем, есть ли сгенерированные файлы
          if ls public_html/external-ai-service/psychology_articles_*.json 1> /dev/null 2>&1; then
            echo "✅ Articles generated successfully" >> $GITHUB_STEP_SUMMARY
            
            # Подсчитываем количество статей
            for file in public_html/external-ai-service/psychology_articles_*.json; do
              if [ -f "$file" ]; then
                count=$(jq '.total_articles' "$file" 2>/dev/null || echo "unknown")
                echo "- **File:** \`$file\`" >> $GITHUB_STEP_SUMMARY
                echo "- **Articles:** $count" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "❌ No articles were generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Logs" >> $GITHUB_STEP_SUMMARY
          if [ -f "public_html/external-ai-service/psychology_processor.log" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -20 public_html/external-ai-service/psychology_processor.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
