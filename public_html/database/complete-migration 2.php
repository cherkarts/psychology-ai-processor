<?php
/**
 * ะะพะปะฝัะน ะฟัะพัะตัั ะผะธะณัะฐัะธะธ ั JSON ะฝะฐ MySQL
 * ะะบะปััะฐะตั ะผะธะณัะฐัะธั ะดะฐะฝะฝัั ะธ ะฟะพะปะฝัั ะพัะธััะบั ะพั JSON
 */

echo "=== ะะะะะะฏ ะะะะะะฆะะฏ ะก JSON ะะ MYSQL ===\n";
echo "ะกะฐะนั ะฟัะธัะพะปะพะณะฐ ะะตะฝะธัะฐ ะงะตัะบะฐัะฐ\n";
echo "=====================================\n\n";

// ะัะพะฒะตััะตะผ, ััะพ ัะบัะธะฟั ะทะฐะฟััะตะฝ ะธะท ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ
if (php_sapi_name() !== 'cli') {
  echo "โ ะญัะพั ัะบัะธะฟั ะดะพะปะถะตะฝ ะฑััั ะทะฐะฟััะตะฝ ะธะท ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ!\n";
  echo "ะัะฟะพะปัะทัะนัะต: php complete-migration.php\n";
  exit(1);
}

// ะะฐะฟัะฐัะธะฒะฐะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
echo "โ๏ธ  ะะะะะะะะ: ะญัะพั ะฟัะพัะตัั ะฟะพะปะฝะพัััั ะธะทะผะตะฝะธั ััััะบัััั ะดะฐะฝะฝัั!\n";
echo "ะัะต JSON ัะฐะนะปั ะฑัะดัั ัะดะฐะปะตะฝั ะฟะพัะปะต ะผะธะณัะฐัะธะธ ะฒ MySQL.\n\n";

echo "ะัะพะดะพะปะถะธัั ะฟะพะปะฝัั ะผะธะณัะฐัะธั? (y/N): ";
$handle = fopen("php://stdin", "r");
$line = fgets($handle);
fclose($handle);

if (trim(strtolower($line)) !== 'y') {
  echo "โ ะะธะณัะฐัะธั ะพัะผะตะฝะตะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ.\n";
  exit(0);
}

echo "\n๐ ะะฐัะธะฝะฐะตะผ ะฟะพะปะฝัั ะผะธะณัะฐัะธั...\n\n";

try {
  // ะจะฐะณ 1: ะะธะณัะฐัะธั ะดะฐะฝะฝัั
  echo "๐ ะจะฐะณ 1: ะะธะณัะฐัะธั ะดะฐะฝะฝัั ะธะท JSON ะฒ MySQL...\n";

  if (file_exists(__DIR__ . '/migrate-to-mysql.php')) {
    // ะะฐะฟััะบะฐะตะผ ะผะธะณัะฐัะธั
    include __DIR__ . '/migrate-to-mysql.php';
    echo "  โ ะะธะณัะฐัะธั ะดะฐะฝะฝัั ะทะฐะฒะตััะตะฝะฐ\n\n";
  } else {
    echo "  โ ะคะฐะนะป ะผะธะณัะฐัะธะธ ะฝะต ะฝะฐะนะดะตะฝ\n";
    exit(1);
  }

  // ะจะฐะณ 2: ะัะธััะบะฐ ะพั JSON
  echo "๐งน ะจะฐะณ 2: ะัะธััะบะฐ ะฟัะพะตะบัะฐ ะพั JSON ัะฐะนะปะพะฒ...\n";

  if (file_exists(__DIR__ . '/cleanup-json.php')) {
    // ะะฐะฟััะบะฐะตะผ ะพัะธััะบั
    include __DIR__ . '/cleanup-json.php';
    echo "  โ ะัะธััะบะฐ ะพั JSON ะทะฐะฒะตััะตะฝะฐ\n\n";
  } else {
    echo "  โ ะคะฐะนะป ะพัะธััะบะธ ะฝะต ะฝะฐะนะดะตะฝ\n";
    exit(1);
  }

  // ะจะฐะณ 3: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
  echo "๐ ะจะฐะณ 3: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ัะธััะตะผั...\n";

  // ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
  require_once __DIR__ . '/../includes/Database.php';
  $db = Database::getInstance();
  $db->selectDatabase('cherkas_therapy');
  echo "  โ ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั ัะฐะฑะพัะฐะตั\n";

  // ะัะพะฒะตััะตะผ ะผะพะดะตะปะธ
  require_once __DIR__ . '/../includes/Models/Product.php';
  require_once __DIR__ . '/../includes/Models/Review.php';
  require_once __DIR__ . '/../includes/Models/Meditation.php';
  require_once __DIR__ . '/../includes/Models/Article.php';
  require_once __DIR__ . '/../includes/Models/Order.php';

  $productModel = new Product();
  $products = $productModel->getAll(['limit' => 1]);
  echo "  โ ะะพะดะตะปั Product ัะฐะฑะพัะฐะตั\n";

  $reviewModel = new Review();
  $reviews = $reviewModel->getApproved(1);
  echo "  โ ะะพะดะตะปั Review ัะฐะฑะพัะฐะตั\n";

  $meditationModel = new Meditation();
  $meditations = $meditationModel->getAll(['limit' => 1]);
  echo "  โ ะะพะดะตะปั Meditation ัะฐะฑะพัะฐะตั\n";

  $articleModel = new Article();
  $articles = $articleModel->getPublished(1);
  echo "  โ ะะพะดะตะปั Article ัะฐะฑะพัะฐะตั\n";

  $orderModel = new Order();
  $orders = $orderModel->getAll(['limit' => 1]);
  echo "  โ ะะพะดะตะปั Order ัะฐะฑะพัะฐะตั\n";

  // ะัะพะฒะตััะตะผ, ััะพ JSON ัะฐะนะปั ัะดะฐะปะตะฝั
  $jsonFiles = [
    'data/products.json',
    'data/reviews.json',
    'data/meditations.json',
    'data/orders.json',
    'data/categories.json'
  ];

  $jsonFilesExist = false;
  foreach ($jsonFiles as $file) {
    if (file_exists(__DIR__ . '/../' . $file)) {
      echo "  โ๏ธ  JSON ัะฐะนะป ะฒัะต ะตัะต ัััะตััะฒัะตั: {$file}\n";
      $jsonFilesExist = true;
    }
  }

  if (!$jsonFilesExist) {
    echo "  โ ะัะต JSON ัะฐะนะปั ัะดะฐะปะตะฝั\n";
  }

  echo "  โ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ะทะฐะฒะตััะตะฝะฐ\n\n";

  // ะคะธะฝะฐะปัะฝัะน ะพััะตั
  echo "๐ ะะะะะะฏ ะะะะะะฆะะฏ ะฃะกะะะจะะ ะะะะะะจะะะ!\n";
  echo "========================================\n\n";

  echo "โ ะงัะพ ะฑัะปะพ ะฒัะฟะพะปะฝะตะฝะพ:\n";
  echo "1. โ ะะธะณัะฐัะธั ะฒัะตั ะดะฐะฝะฝัั ะธะท JSON ะฒ MySQL\n";
  echo "2. โ ะกะพะทะดะฐะฝะธะต ะฒัะตั ะฝะตะพะฑัะพะดะธะผัั ัะฐะฑะปะธั\n";
  echo "3. โ ะะฑะฝะพะฒะปะตะฝะธะต ะฒัะตั ัะฐะนะปะพะฒ ะดะปั ัะฐะฑะพัั ั ะะ\n";
  echo "4. โ ะฃะดะฐะปะตะฝะธะต ะฒัะตั JSON ัะฐะนะปะพะฒ\n";
  echo "5. โ ะัะธััะบะฐ ะบะพะดะฐ ะพั ัััะปะพะบ ะฝะฐ JSON\n";
  echo "6. โ ะะฑะฝะพะฒะปะตะฝะธะต ะดะพะบัะผะตะฝัะฐัะธะธ\n";
  echo "7. โ ะัะพะฒะตัะบะฐ ัะตะปะพััะฝะพััะธ ัะธััะตะผั\n\n";

  echo "๐ ะะตะทัะปััะฐั:\n";
  echo "- ะัะต ะดะฐะฝะฝัะต ัะตะฟะตัั ััะฐะฝัััั ะฒ MySQL\n";
  echo "- JSON ัะฐะนะปั ะฟะพะปะฝะพัััั ัะดะฐะปะตะฝั\n";
  echo "- ะะพะด ะพัะธัะตะฝ ะพั ัััะปะพะบ ะฝะฐ JSON\n";
  echo "- ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั\n\n";

  echo "๐ง ะกะปะตะดัััะธะต ัะฐะณะธ:\n";
  echo "1. ะัะพะฒะตัััะต ัะฐะฑะพัั ัะฐะนัะฐ ะฒ ะฑัะฐัะทะตัะต\n";
  echo "2. ะัะพะฒะตัััะต ัะฐะฑะพัั ะฐะดะผะธะฝ-ะฟะฐะฝะตะปะธ\n";
  echo "3. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ััะฝะบัะธะธ ัะฐะฑะพัะฐัั\n";
  echo "4. ะัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ ัะดะฐะปะธัะต ะฟะฐะฟะบั data/ ะฟะพะปะฝะพัััั\n";
  echo "5. ะะฑะฝะพะฒะธัะต .gitignore (ะตัะปะธ ะธัะฟะพะปัะทัะตัะต Git)\n\n";

  echo "โ๏ธ  ะะฐะถะฝัะต ะทะฐะผะตัะฐะฝะธั:\n";
  echo "- ะัะต ัะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ัะพััะฐะฝะตะฝั ะฒ ะฟะฐะฟะบะต database/backup_*\n";
  echo "- ะัะพะตะบั ะฟะพะปะฝะพัััั ะฟะตัะตัะตะป ะฝะฐ ะฑะฐะทั ะดะฐะฝะฝัั\n";
  echo "- ะกะธััะตะผะฐ ััะฐะปะฐ ะฑะพะปะตะต ะฝะฐะดะตะถะฝะพะน ะธ ะผะฐัััะฐะฑะธััะตะผะพะน\n";
  echo "- ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั ะทะฝะฐัะธัะตะปัะฝะพ ัะปัััะธะปะฐัั\n\n";

  echo "๐ฏ ะัะตะธะผััะตััะฒะฐ ะฟะพัะปะต ะผะธะณัะฐัะธะธ:\n";
  echo "- โก ะัััััะต ะทะฐะฟัะพัั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั\n";
  echo "- ๐ ะขัะฐะฝะทะฐะบัะธะพะฝะฝะพััั ะธ ัะตะปะพััะฝะพััั ะดะฐะฝะฝัั\n";
  echo "- ๐ ะะพะทะผะพะถะฝะพััั ัะปะพะถะฝัั ะทะฐะฟัะพัะพะฒ ะธ ะฐะฝะฐะปะธัะธะบะธ\n";
  echo "- ๐ก๏ธ ะัััะฐั ะฑะตะทะพะฟะฐัะฝะพััั ะธ ะทะฐัะธัะฐ ะพั ะพัะธะฑะพะบ\n";
  echo "- ๐ ะะพัะพะฒะฝะพััั ะบ ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั\n\n";

  echo "ะกะฟะฐัะธะฑะพ ะทะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัะธััะตะผั ะฟะพะปะฝะพะน ะผะธะณัะฐัะธะธ!\n";
  echo "ะะฐั ัะฐะนั ัะตะฟะตัั ัะฐะฑะพัะฐะตั ะฝะฐ ัะพะฒัะตะผะตะฝะฝะพะน ะฐััะธัะตะบัััะต!\n";

} catch (Exception $e) {
  echo "\nโ ะะะะขะะงะะกะะะฏ ะะจะะะะ!\n";
  echo "========================\n";
  echo "ะัะธะฑะบะฐ: " . $e->getMessage() . "\n";
  echo "ะคะฐะนะป: " . $e->getFile() . "\n";
  echo "ะกััะพะบะฐ: " . $e->getLine() . "\n\n";

  echo "๐ง ะะตะบะพะผะตะฝะดะฐัะธะธ:\n";
  echo "1. ะัะพะฒะตัััะต ัะตะทะตัะฒะฝัะต ะบะพะฟะธะธ ะฒ ะฟะฐะฟะบะต database/backup_*\n";
  echo "2. ะะพัััะฐะฝะพะฒะธัะต ัะฐะนะปั ะธะท ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ\n";
  echo "3. ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฑะฐะทั ะดะฐะฝะฝัั\n";
  echo "4. ะฃะฑะตะดะธัะตัั, ััะพ XAMPP ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ\n\n";

  exit(1);
}
?>