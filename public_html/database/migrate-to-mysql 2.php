<?php
/**
 * ะะปะฐะฒะฝัะน ัะบัะธะฟั ะดะปั ะฟะพะปะฝะพะน ะผะธะณัะฐัะธะธ ั JSON ะฝะฐ MySQL
 * ะัะฟะพะปะฝัะตั ะฒัะต ะฝะตะพะฑัะพะดะธะผัะต ัะฐะณะธ ะดะปั ะฟะตัะตัะพะดะฐ
 */

echo "=== ะะะะะะฆะะฏ ะก JSON ะะ MYSQL ===\n";
echo "ะกะฐะนั ะฟัะธัะพะปะพะณะฐ ะะตะฝะธัะฐ ะงะตัะบะฐัะฐ\n";
echo "================================\n\n";

// ะัะพะฒะตััะตะผ, ััะพ ัะบัะธะฟั ะทะฐะฟััะตะฝ ะธะท ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ
if (php_sapi_name() !== 'cli') {
  echo "โ ะญัะพั ัะบัะธะฟั ะดะพะปะถะตะฝ ะฑััั ะทะฐะฟััะตะฝ ะธะท ะบะพะผะฐะฝะดะฝะพะน ัััะพะบะธ!\n";
  echo "ะัะฟะพะปัะทัะนัะต: php migrate-to-mysql.php\n";
  exit(1);
}

// ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะฝะตะพะฑัะพะดะธะผัั ัะฐะนะปะพะฒ
$requiredFiles = [
  'includes/Database.php',
  'includes/Models/Product.php',
  'includes/Models/Review.php',
  'includes/Models/Meditation.php',
  'includes/Models/Article.php',
  'includes/Models/Order.php',
  'database/schema.sql',
  'database/migrate-json-to-mysql.php',
  'database/update-json-references.php'
];

echo "๐ ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต ะฝะตะพะฑัะพะดะธะผัั ัะฐะนะปะพะฒ...\n";
foreach ($requiredFiles as $file) {
  if (!file_exists(__DIR__ . '/../' . $file)) {
    echo "โ ะคะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ: {$file}\n";
    exit(1);
  }
  echo "  โ {$file}\n";
}

echo "\n๐ ะะปะฐะฝ ะผะธะณัะฐัะธะธ:\n";
echo "1. ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ\n";
echo "2. ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั\n";
echo "3. ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั (ะตัะปะธ ะฝะต ัััะตััะฒััั)\n";
echo "4. ะะธะณัะฐัะธั ะดะฐะฝะฝัั ะธะท JSON ะฒ MySQL\n";
echo "5. ะะฑะฝะพะฒะปะตะฝะธะต ัะฐะนะปะพะฒ ะดะปั ัะฐะฑะพัั ั ะฑะฐะทะพะน ะดะฐะฝะฝัั\n";
echo "6. ะขะตััะธัะพะฒะฐะฝะธะต ัะธััะตะผั\n\n";

// ะะฐะฟัะฐัะธะฒะฐะตะผ ะฟะพะดัะฒะตัะถะดะตะฝะธะต
echo "โ๏ธ  ะะะะะะะะ: ะญัะพั ะฟัะพัะตัั ะธะทะผะตะฝะธั ััััะบัััั ะดะฐะฝะฝัั ะฒะฐัะตะณะพ ัะฐะนัะฐ!\n";
echo "ะะตะบะพะผะตะฝะดัะตััั ัะพะทะดะฐัั ะฟะพะปะฝัั ัะตะทะตัะฒะฝัั ะบะพะฟะธั ะฟัะพะตะบัะฐ ะฟะตัะตะด ะฝะฐัะฐะปะพะผ.\n\n";

echo "ะัะพะดะพะปะถะธัั ะผะธะณัะฐัะธั? (y/N): ";
$handle = fopen("php://stdin", "r");
$line = fgets($handle);
fclose($handle);

if (trim(strtolower($line)) !== 'y') {
  echo "โ ะะธะณัะฐัะธั ะพัะผะตะฝะตะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ.\n";
  exit(0);
}

echo "\n๐ ะะฐัะธะฝะฐะตะผ ะผะธะณัะฐัะธั...\n\n";

try {
  // ะจะฐะณ 1: ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ
  echo "๐ฆ ะจะฐะณ 1: ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ...\n";
  $backupDir = __DIR__ . '/backup_full_' . date('Y-m-d_H-i-s');
  if (!is_dir($backupDir)) {
    mkdir($backupDir, 0755, true);
  }

  // ะะพะฟะธััะตะผ JSON ัะฐะนะปั
  $jsonFiles = ['products.json', 'reviews.json', 'meditations.json', 'orders.json', 'categories.json'];
  foreach ($jsonFiles as $file) {
    $sourcePath = __DIR__ . '/../data/' . $file;
    if (file_exists($sourcePath)) {
      copy($sourcePath, $backupDir . '/' . $file);
      echo "  โ ะะตะทะตัะฒะฝะฐั ะบะพะฟะธั: data/{$file}\n";
    }
  }

  echo "  โ ะะตะทะตัะฒะฝะฐั ะบะพะฟะธั ัะพะทะดะฐะฝะฐ ะฒ: {$backupDir}\n\n";

  // ะจะฐะณ 2: ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
  echo "๐ ะจะฐะณ 2: ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั...\n";
  require_once __DIR__ . '/../includes/Database.php';

  try {
    $db = Database::getInstance();
    $db->selectDatabase('cherkas_therapy');
    echo "  โ ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั ััะฟะตัะฝะพ\n";
  } catch (Exception $e) {
    echo "โ ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั: " . $e->getMessage() . "\n";
    echo "ะฃะฑะตะดะธัะตัั, ััะพ:\n";
    echo "- XAMPP ะทะฐะฟััะตะฝ\n";
    echo "- MySQL ัะตัะฒะตั ัะฐะฑะพัะฐะตั\n";
    echo "- ะะฐะทะฐ ะดะฐะฝะฝัั 'cherkas_therapy' ัััะตััะฒัะตั\n";
    exit(1);
  }

  // ะจะฐะณ 3: ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั
  echo "\n๐๏ธ  ะจะฐะณ 3: ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธั ะฑะฐะทั ะดะฐะฝะฝัั...\n";
  $schemaFile = __DIR__ . '/schema.sql';
  if (file_exists($schemaFile)) {
    $schema = file_get_contents($schemaFile);
    $statements = explode(';', $schema);

    foreach ($statements as $statement) {
      $statement = trim($statement);
      if (!empty($statement)) {
        try {
          $db->execute($statement);
          echo "  โ ะัะฟะพะปะฝะตะฝ SQL: " . substr($statement, 0, 50) . "...\n";
        } catch (Exception $e) {
          // ะะณะฝะพัะธััะตะผ ะพัะธะฑะบะธ ัะพะทะดะฐะฝะธั ัะฐะฑะปะธั, ะตัะปะธ ะพะฝะธ ัะถะต ัััะตััะฒััั
          if (strpos($e->getMessage(), 'already exists') === false) {
            echo "  โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะต: " . $e->getMessage() . "\n";
          }
        }
      }
    }
    echo "  โ ะขะฐะฑะปะธัั ัะพะทะดะฐะฝั/ะฟัะพะฒะตัะตะฝั\n";
  } else {
    echo "โ ะคะฐะนะป ััะตะผั ะฝะต ะฝะฐะนะดะตะฝ: schema.sql\n";
    exit(1);
  }

  // ะจะฐะณ 4: ะะธะณัะฐัะธั ะดะฐะฝะฝัั ะธะท JSON
  echo "\n๐ ะจะฐะณ 4: ะะธะณัะฐัะธั ะดะฐะฝะฝัั ะธะท JSON ะฒ MySQL...\n";
  require_once __DIR__ . '/migrate-json-to-mysql.php';

  $migrator = new JsonToMysqlMigrator();
  $migrator->migrateAll();
  echo "  โ ะะฐะฝะฝัะต ะผะธะณัะธัะพะฒะฐะฝั\n";

  // ะจะฐะณ 5: ะะฑะฝะพะฒะปะตะฝะธะต ัะฐะนะปะพะฒ
  echo "\n๐ ะจะฐะณ 5: ะะฑะฝะพะฒะปะตะฝะธะต ัะฐะนะปะพะฒ ะดะปั ัะฐะฑะพัั ั ะฑะฐะทะพะน ะดะฐะฝะฝัั...\n";
  require_once __DIR__ . '/update-json-references.php';

  $updater = new JsonToMysqlUpdater();
  $updater->updateAllFiles();
  echo "  โ ะคะฐะนะปั ะพะฑะฝะพะฒะปะตะฝั\n";

  // ะจะฐะณ 6: ะขะตััะธัะพะฒะฐะฝะธะต
  echo "\n๐งช ะจะฐะณ 6: ะขะตััะธัะพะฒะฐะฝะธะต ัะธััะตะผั...\n";

  // ะขะตััะธััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ ะผะพะดะตะปัะผ
  require_once __DIR__ . '/../includes/Models/Product.php';
  require_once __DIR__ . '/../includes/Models/Review.php';
  require_once __DIR__ . '/../includes/Models/Meditation.php';
  require_once __DIR__ . '/../includes/Models/Article.php';
  require_once __DIR__ . '/../includes/Models/Order.php';

  try {
    $productModel = new Product();
    $products = $productModel->getAll(['limit' => 1]);
    echo "  โ ะะพะดะตะปั Product ัะฐะฑะพัะฐะตั\n";

    $reviewModel = new Review();
    $reviews = $reviewModel->getApproved(1);
    echo "  โ ะะพะดะตะปั Review ัะฐะฑะพัะฐะตั\n";

    $meditationModel = new Meditation();
    $meditations = $meditationModel->getAll(['limit' => 1]);
    echo "  โ ะะพะดะตะปั Meditation ัะฐะฑะพัะฐะตั\n";

    $articleModel = new Article();
    $articles = $articleModel->getPublished(1);
    echo "  โ ะะพะดะตะปั Article ัะฐะฑะพัะฐะตั\n";

    $orderModel = new Order();
    $orders = $orderModel->getAll(['limit' => 1]);
    echo "  โ ะะพะดะตะปั Order ัะฐะฑะพัะฐะตั\n";

  } catch (Exception $e) {
    echo "โ ะัะธะฑะบะฐ ัะตััะธัะพะฒะฐะฝะธั: " . $e->getMessage() . "\n";
    exit(1);
  }

  // ะคะธะฝะฐะปัะฝัะต ะธะฝััััะบัะธะธ
  echo "\n๐ ะะะะะะฆะะฏ ะฃะกะะะจะะ ะะะะะะจะะะ!\n";
  echo "================================\n\n";

  echo "โ ะงัะพ ะฑัะปะพ ัะดะตะปะฐะฝะพ:\n";
  echo "- ะกะพะทะดะฐะฝะฐ ัะตะทะตัะฒะฝะฐั ะบะพะฟะธั ะฒ: {$backupDir}\n";
  echo "- ะกะพะทะดะฐะฝั ะฒัะต ะฝะตะพะฑัะพะดะธะผัะต ัะฐะฑะปะธัั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั\n";
  echo "- ะัะต ะดะฐะฝะฝัะต ะธะท JSON ัะฐะนะปะพะฒ ะฟะตัะตะฝะตัะตะฝั ะฒ MySQL\n";
  echo "- ะัะต ัะฐะนะปั ะพะฑะฝะพะฒะปะตะฝั ะดะปั ัะฐะฑะพัั ั ะฑะฐะทะพะน ะดะฐะฝะฝัั\n";
  echo "- ะกะธััะตะผะฐ ะฟัะพัะตััะธัะพะฒะฐะฝะฐ ะธ ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ\n\n";

  echo "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:\n";
  echo "1. ะัะพะฒะตัััะต ัะฐะฑะพัั ัะฐะนัะฐ ะฒ ะฑัะฐัะทะตัะต\n";
  echo "2. ะัะพะฒะตัััะต ัะฐะฑะพัั ะฐะดะผะธะฝ-ะฟะฐะฝะตะปะธ\n";
  echo "3. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ััะฝะบัะธะธ ัะฐะฑะพัะฐัั ะบะพััะตะบัะฝะพ\n";
  echo "4. ะัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ ัะดะฐะปะธัะต ััะฐััะต JSON ัะฐะนะปั ะธะท ะฟะฐะฟะบะธ data/\n\n";

  echo "โ๏ธ  ะะฐะถะฝัะต ะทะฐะผะตัะฐะฝะธั:\n";
  echo "- ะะตะทะตัะฒะฝะฐั ะบะพะฟะธั ัะพััะฐะฝะตะฝะฐ ะฒ: {$backupDir}\n";
  echo "- ะกัะฐััะต JSON ัะฐะนะปั ะฑะพะปััะต ะฝะต ะธัะฟะพะปัะทััััั\n";
  echo "- ะัะต ะดะฐะฝะฝัะต ัะตะฟะตัั ััะฐะฝัััั ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั\n";
  echo "- ะกะธััะตะผะฐ ััะฐะปะฐ ะฑะพะปะตะต ะฝะฐะดะตะถะฝะพะน ะธ ะผะฐัััะฐะฑะธััะตะผะพะน\n\n";

  echo "๐ง ะัะปะธ ะฒะพะทะฝะธะบะปะธ ะฟัะพะฑะปะตะผั:\n";
  echo "- ะัะพะฒะตัััะต ะปะพะณะธ ะพัะธะฑะพะบ\n";
  echo "- ะะพัััะฐะฝะพะฒะธัะต ัะฐะนะปั ะธะท ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ\n";
  echo "- ะะฑัะฐัะธัะตัั ะบ ะดะพะบัะผะตะฝัะฐัะธะธ\n\n";

  echo "ะกะฟะฐัะธะฑะพ ะทะฐ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัะธััะตะผั ะผะธะณัะฐัะธะธ!\n";

} catch (Exception $e) {
  echo "\nโ ะะะะขะะงะะกะะะฏ ะะจะะะะ!\n";
  echo "========================\n";
  echo "ะัะธะฑะบะฐ: " . $e->getMessage() . "\n";
  echo "ะคะฐะนะป: " . $e->getFile() . "\n";
  echo "ะกััะพะบะฐ: " . $e->getLine() . "\n\n";

  echo "๐ง ะะตะบะพะผะตะฝะดะฐัะธะธ:\n";
  echo "1. ะัะพะฒะตัััะต ัะตะทะตัะฒะฝัั ะบะพะฟะธั ะฒ: {$backupDir}\n";
  echo "2. ะะพัััะฐะฝะพะฒะธัะต ัะฐะนะปั ะธะท ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ\n";
  echo "3. ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฑะฐะทั ะดะฐะฝะฝัั\n";
  echo "4. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั\n\n";

  exit(1);
}
?>